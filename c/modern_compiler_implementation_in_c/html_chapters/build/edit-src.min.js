!function(a,b){function c(a){var b=a.split(".");return b.length>1&&["jpg","jpeg","png","bmp","gif"].indexOf(b[b.length-1].toLowerCase())>-1}function d(a){c(a)?m.insert("\n\n!["+a+"]("+a+")\n\n"):m.insert("\n\n["+a+"]("+a+")\n\n")}function e(){"success"==A.contentDocument.body.innerText?d(D):alert("Failed to upload"),E.innerText="Attach File",A.removeEventListener("load",e)}function f(a){var b=location.pathname;return b.slice(0,b.lastIndexOf("/")+1)+a}function g(a){a.stopPropagation(),a.preventDefault()}console.log("!");var h=new Persist.Store("strapdown_editor",{swf_path:"/persist.swf"}),i=b.getElementsByTagName("xmp")[0]||b.getElementsByTagName("textarea")[0],j=i.getAttribute("version"),k=a.location.pathname+"#"+j,l=h.get(k),m=ace.edit("editor"),n=m.getSession();m.setTheme("ace/theme/monokai"),n.setMode("ace/mode/markdown"),n.setOption("wrap",!0),n.setTabSize(2),n.setUseSoftTabs(!0);var o=b.getElementsByTagName("title")[0].innerText,p=b.getElementById("headline");p&&(p.innerHTML=o),l&&l!=m.getValue()?(confirm("Detected unsaved document cache, do you want to load the cache?")&&n.setValue(l),h.remove(k)):h.remove(k);var q=b.getElementById("savValue"),r=b.getElementsByTagName("form")[0],s=b.getElementsByClassName("navbar-toggle")[0],t=b.getElementsByClassName("navbar-collapse")[0];addEvent(r,"submit",function(){v=!1,q.value=m.getValue(),h.set(k,n.getValue())}),addEvent(s,"click",function(){var a=t.className.split(" ");a.indexOf("collapse")>-1?a.splice(a.indexOf("collapse"),1):a.push("collapse"),t.className=a.join(" ")});var u=Date.now()-2e3,v=!1;m.on("change",function(a){var b=Date.now();b-u>2e3&&(h.set(k,n.getValue()),u=b)}),n.on("change",function(a){v=v||!0}),a.onbeforeunload=function(){return h.set(k,n.getValue()),v?"Document unsaved, discard changes and close window?":void 0};var w=b.getElementsByClassName("render-target")[0],x=new Persist.Store("strapdown",{swf_path:"/persist.swf"}),y=x.get("theme")||"chaitin",z=b.getElementById("preview-toggle");addEvent(z,"click",function(){if("none"==w.style.display){i.style.width="50%",m.resize();var a=n.getValue();w.innerHTML="";var c=b.createElement("div");c.className="container",c.id="content",w.appendChild(c),render(c,a,y,null,!1),w.style.marginLeft="50%",w.style.width="50%",w.style.display="block",setInnerText(z,"FullScreen Editing")}else w.style.display="none",i.style.width="",m.resize(),setInnerText(z,"Instant Preview"),b.getElementsByTagName("textarea")[0].focus()}),m.on("change",function(){if("none"!==w.style.display){var a=n.getValue();w.innerHTML="";var c=b.createElement("div");c.className="container",c.id="content",w.appendChild(c),render(c,a,y,null,!1)}});var A,B,C,D,E=b.getElementById("upload-btn"),F=b.getElementById("upload-area");E.addEventListener("click",function(){F.innerHTML='<form action="" method="post" id="upload-form" enctype="multipart/form-data"><input type="file" id="file-body" name="body"></form><iframe id="upload-iframe" name="upload-iframe" style="display: none;width: 0;height: 0;tab-index: -1">',B=b.getElementById("file-body"),A=b.getElementById("upload-iframe"),B.click(),B.addEventListener("change",function(){var a=b.getElementById("upload-form");C=B.value.split(/(\\|\/)/g).pop(),D=f(C),a.action=D+"?upload",A.src=D+"?upload",a.target="upload-iframe",A.addEventListener("load",e,!1),a.submit(),E.innerText="Uploading"},!1)},!1);var G=b.getElementById("editor");G.addEventListener("dragover",g,!1),G.addEventListener("dragleave",g,!1),G.addEventListener("drop",function(a){g(a);var b=a.target.files||a.dataTransfer.files,c=new XMLHttpRequest,e=f(b[0].name);c.onreadystatechange=function(a){4==c.readyState&&("success"==c.responseText?d(e):alert("Failed to upload"))},c.open("post",e+"?upload",!0),c.setRequestHeader("X-Requested-With","XMLHttpRequest");var h=new FormData;h.append("body",b[0]),c.send(h)},!1),modals.init({backspaceClose:!1}),b.getElementById("option-btn").addEventListener("click",function(){modals.openModal(null,"#option-modal")}),b.getElementById("option-submit-btn").addEventListener("click",function(){function a(a){if(!a)return!0;for(var b=a.split("."),c=0;c<b.length;c++)if("a"!=b[c]&&"i"!=b[c])return!1;return!0}var c=b.getElementById("Title").value,d=b.getElementById("HeadingNumber").value,e=b.getElementById("Toc").checked;if(!c)return void alert("Title can not be empty");if(!a(d))return void alert('Heading Number format error, it should like "i.a\'a.i"');var f=new XMLHttpRequest;f.onreadystatechange=function(){if(4==f.readyState){JSON.parse(f.responseText).code?alert("Failed to save option"):(alert("Success"),modals.closeModals(null,"#option-modal"))}},f.open("POST",location.pathname+"?option"),f.setRequestHeader("Content-Type","application/json"),d||(d="false"),f.send(JSON.stringify({Title:c,HeadingNumber:d,Toc:e.toString()}))})}(window,document);